---
#
#  A Kubernetes Pod manifest template. Projects a
#  Tycho system object into a YAML pod definition.
#  Tags the object with a system unique
#  GUID label to enable later management.
#
#  Generated by Tycho {{ now() }}
#
apiVersion: v1
kind: Pod
metadata:
  name: {{ system.name }}
  labels:
    name: {{ system.name }}
    username: {{ system.username }}
    app-name: {{ system.system_name }}
    original-app-name: {{ system.system_name }}
    reaper-label: {{ system.system_name }}
    executor: tycho
    tycho-guid: {{ system.identifier }}
    tycho-app-id: {{ system.app_id }}
spec:
{% if system.serviceaccount %}
  serviceAccountName: {{system.serviceaccount}}
{% endif %}
{% for container in system.containers %}
  {% if container.limits or container.requests %}
  {% if container.limits.gpus != None and loop.first %}
  tolerations:
  - key: "{{ system.gpu_resource_name }}"
    operator: "Exists"
    effect: "NoSchedule"
  {% endif %}
  {% endif %}
  {% if system.security_context["run_as_user"] or system.security_context.run_as_group or system.security_context.fs_group %}
  securityContext:
    {% if system.security_context["run_as_user"] %}
    runAsUser: {{ system.security_context["run_as_user"] }}
    {% endif %}
    {% if system.security_context.run_as_group %}
    runAsGroup: {{ system.security_context.run_as_group }}
    {% endif %}
    {% if system.security_context.fs_group %}
    fsGroup: {{ system.security_context.fs_group }}
    {% endif %}
  {% endif %}
{% if (system.enable_init_container == "true") and (system.create_home_dirs == "true") and (system.dev_phase != "test") %}
  initContainers:
  - name: volume-tasks
    image: {{ system.init_image_repository }}:{{ system.init_image_tag }}
    {% if system.init_security_context.run_as_user or system.init_security_context.run_as_group %}
    securityContext:
      {% if system.init_security_context.run_as_user %}
      runAsUser: {{ system.init_security_context.run_as_user }}
      {% endif %}
      {% if system.init_security_context.run_as_group %}
      runAsGroup: {{ system.init_security_context.run_as_group }}
      {% endif %}
    {% endif %}
    # Fixed resources
    resources:
      requests:
        memory: {{ system.init_memory }}
        cpu: {{ system.init_cpus }}
      limits:
        memory: {{ system.init_memory }}
        cpu: {{ system.init_cpus }}
    command: [ 'sh', '-c' ]
    args:
      - mkdir -p {{ system.parent_dir }}/{{ system.subpath_dir }} &&
        mkdir -p {{ system.parent_dir }}/{{ system.shared_dir }} &&
        {% if system.gitea_integration == True %}
        mkdir -p {{ system.parent_dir }}/{{ system.subpath_dir }}/.ssh &&
        echo -e "Host {{ system.gitea_host }}\n     Hostname {{ system.gitea_service_name }}\n     User {{ system.gitea_user }}\n     IdentityFile ~/.ssh/id_gitea" > {{ system.parent_dir }}/{{ system.subpath_dir }}/.ssh/config &&
        {% endif %}
        ls -aln {{ system.parent_dir }} &&
        echo OK
    volumeMounts:
    - name: {{ system.stdnfs_pvc }}
      mountPath: {{ system.parent_dir }}
{% endif %}
{% endfor %}
  containers:
{% for container in system.containers %}    
  - name: {{ container.name }}
    image: {{ container.image }}
    {% if system.security_context.run_as_user or system.security_context.run_as_group %}
    securityContext:
      {% if system.security_context.run_as_user %}
      runAsUser: {{ system.security_context.run_as_user }}
      {% endif %}
      {% if system.security_context.run_as_group %}
      runAsGroup: {{ system.security_context.run_as_group }}
      {% endif %}
    {% endif %}
{% if container.command %}
    command: {{ container.command }}
{% endif %}
    env:
{% if container.env %}
    {%for e in container.env %}
    - name : {{ e[0] }}
      value : "{{ e[1] }}"
    {% endfor %}
    - name : GUID
      value: {{ system.identifier }}
    - name: USER_NAME
      value: {{ system.username }}
    - name: USER
      value: {{ system.username }}
    {% if system.amb %}
    - name: NB_PREFIX
      value: /private/{{system.system_name}}/{{system.username}}/{{system.identifier}}
    - name: FB_BASEURL
      value: /private/{{system.system_name}}/{{system.username}}/{{system.identifier}}
    {% else %}
    - name: NB_PREFIX
      value: /
    - name: FB_BASEURL
      value: /
    {% endif %}
{% endif %}
    - name: HOST
      value: {{ system.host }}
{% if not container.env %}
    - name : GUID
      value: {{ system.identifier }}
    - name: USER_NAME
      value: {{ system.username }}
    - name: USER
      value: {{ system.username }}
    {% if system.amb %}
    - name: NB_PREFIX
      value: /private/{{system.system_name}}/{{system.username}}/{{system.identifier}}
    - name: FB_BASEURL
      value: /private/{{system.system_name}}/{{system.username}}/{{system.identifier}}
    {% else %}
    - name: NB_PREFIX
      value: /
    - name: FB_BASEURL
      value: /
    {% endif %}
{% endif %}
{% if system.system_env %}
  {% for env in system.system_env %}
    - name: {{ env }}
      value: {{ system.system_env[env]}}
  {% endfor %}
{% endif %}
{% if container.expose|length > 0 %}
    ports:
{% for port in container.expose %}
    - containerPort: {{ container.expose[loop.index-1]['containerPort'] }}
      protocol: TCP
{% endfor %}     
{% endif %} # ports
{% if container.limits or container.requests %}
    resources:
      limits:
      {% if container.limits %}
      {% if container.limits.cpus != None %}
        cpu: "{{ container.limits.cpus }}"
        memory: "{{ container.limits.memory }}"
      {% endif %}
      {% if container.limits.gpus != None %}
        {{ system.gpu_resource_name }}: {{ container.limits.gpus }}
      {% endif %}
      {% if container.limits.ephemeralStorage != None and container.limits.ephemeralStorage != "0" and container.limits.ephemeralStorage != "" %}
        ephemeral-storage: {{ container.limits.ephemeralStorage }}
      {% endif %}
      {% endif %}
      requests:
      {% if container.requests  %}
      {% if container.requests.cpus != None %}
        cpu: "{{ container.requests.cpus }}"
        memory: "{{ container.requests.memory }}"
      {% endif %}
      {% if container.requests.gpus != None %}
        {{ system.gpu_resource_name }}: {{ container.requests.gpus }}
      {% endif %}
      {% if container.requests.ephemeralStorage != None and container.requests.ephemeralStorage != "0" and container.requests.ephemeralStorage != "" %}
        ephemeral-storage: {{ container.requests.ephemeralStorage }}
      {% endif %}
      {% endif %}
{% endif %}
    volumeMounts:
    {% if system.irods_enabled == True %}
    - name: nfs
      mountPath: "/home/nfs"
    {% endif %}
    {% if system.gitea_integration == True %}
    - name: {{ system.username_all_hyphens }}-id-gitea
      mountPath: {{ system.parent_dir }}/{{ system.subpath_dir }}/.ssh/id_gitea
      subPath: id_gitea
      readOnly: true
    {% endif %}
{% if container.volumes %}
{% for volume in system.volumes %}
  {% if container.name == volume['container_name'] %}
    - name: {{ volume["volume_name"] }}
      mountPath: {{ volume["path"] }}
      subPath: {{ volume["subpath"] }}
      readOnly: false
  {% endif %}
  {% endfor %}
  {% endif %}
{% if container.liveness_probe %}
    livenessProbe:
      {% if container.liveness_probe.cmd %}
      exec:
        command:
          {% for arg in container.liveness_probe.cmd %}
          - {{ arg }}
          {% endfor %}
      {% elif container.liveness_probe.port and container.liveness_probe.path %}
      httpGet:
        path: {{ container.liveness_probe.path }}
        port: {{ container.liveness_probe.port }}
        {% if container.liveness_probe.httpHeaders %}
        httpHeaders:
          {% for name in container.liveness_probe.httpHeaders %}
          - name: {{ name }}
            value: {{ container.liveness_probe.httpHeaders[name] }}
          {% endfor %}
        {% endif %}
      {% elif container.liveness_probe.port %}
      tcpSocket:
        port: {{ container.liveness_probe.port }}
      {% endif %}
    {% if container.liveness_probe.delay %}
    initialDelaySeconds: {{ container.liveness_probe.delay }}
    {% endif %}
    {% if container.liveness_probe.period %}
    periodSeconds: {{ container.liveness_probe.period }}
    {% endif %}
    {% if container.liveness_probe.threshold %}
    failureThreshold: {{ container.liveness_probe.threshold }}
    {% endif %}
{% endif %}
{% if container.readiness_probe %}
    readinessProbe:
      {% if container.readiness_probe.cmd %}
      exec:
        command:
          {% for arg in container.readiness_probe.cmd %}
          - {{ arg }}
          {% endfor %}
      {% elif container.readiness_probe.port and container.readiness_probe.path %}
      httpGet:
        path: {{ container.readiness_probe.path }}
        port: {{ container.readiness_probe.port }}
        {% if container.readiness_probe.httpHeaders %}
        httpHeaders:
          {% for name in container.readiness_probe.httpHeaders %}
          - name: {{ name }}
            value: {{ container.readiness_probe.httpHeaders[name] }}
          {% endfor %}
        {% endif %}
      {% elif container.readiness_probe.port %}
      tcpSocket:
        port: {{ container.readiness_probe.port }}
      {% endif %}
    {% if container.readiness_probe.delay %}
    initialDelaySeconds: {{ container.readiness_probe.delay }}
    {% endif %}
    {% if container.readiness_probe.period %}
    periodSeconds: {{ container.readiness_probe.period }}
    {% endif %}
    {% if container.readiness_probe.threshold %}
    failureThreshold: {{ container.readiness_probe.threshold }}
    {% endif %}
{% endif %}
{% endfor %}
  volumes:
  {% if system.irods_enabled == True %}
  - name: nfs
    nfs:
      server: {{ system.nfsrods_host }}
      path: /
  {% endif %}
  {% if system.gitea_integration == True %}
  - name: {{ system.username_all_hyphens }}-id-gitea
    secret:
      secretName: {{ system.username_all_hyphens }}-id-gitea
      defaultMode: 0600
  {% endif %}
# Changes
{% for container in system.containers %}
{% if container.volumes %}
{% for volume in system.volumes %}
  {% if container.name == volume['container_name']%}
  {% if volume["pvc_name"] != None %}
  - name: {{ volume["volume_name"] }}
    persistentVolumeClaim:
      claimName: {{ volume["pvc_name"] }}
  {% endif %}
  {% endif %}
  {% endfor %}
  {% endif %}
  {% endfor %}

